name: iOS Build and TestFlight Deploy

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}

jobs:
  build-ios:
    name: Build iOS & Submit to TestFlight
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v4

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: ðŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ Build iOS & Submit to TestFlight
        run: |
          echo "ðŸ”¨ Building iOS app and submitting to TestFlight..."
          eas build --platform ios --profile preview --auto-submit --non-interactive --wait

      - name: ðŸŽ‰ Success Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ iOS Build & TestFlight Upload Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… What happened:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¨ iOS app built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Automatically submitted to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± Testers will receive notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Check TestFlight app for the new build" >> $GITHUB_STEP_SUMMARY
          echo "- Your testers should receive notifications automatically" >> $GITHUB_STEP_SUMMARY
          echo "- Build will be available for internal testing immediately" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build completed at:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Failure Summary
        if: failure()
        run: |
          echo "## âŒ iOS Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Troubleshooting:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the build logs above for specific errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify App Store Connect API credentials in EAS" >> $GITHUB_STEP_SUMMARY
          echo "3. Ensure your Apple Developer account is active" >> $GITHUB_STEP_SUMMARY
          echo "4. Check that bundle identifier matches App Store Connect" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed at:** $(date)" >> $GITHUB_STEP_SUMMARY

  # PR Validation (no builds, just validation)
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v4

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… PR Validation Complete
        run: |
          echo "âœ… Pull Request validation complete!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ iOS build will run when merged to dev branch" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Merge this PR to trigger TestFlight upload" >> $GITHUB_STEP_SUMMARY
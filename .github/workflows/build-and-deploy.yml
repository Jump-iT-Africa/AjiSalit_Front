name: :pomme: iOS Build & TestFlight Deploy
on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:
env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
jobs:
  ios-build-and-deploy:
    name: :fusée: Build iOS & Deploy to TestFlight
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev' || github.event_name == 'workflow_dispatch'
    steps:
      - name: :construction_bâtiment: Checkout repository
        uses: actions/checkout@v4
      - name: :construction_bâtiment: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
      - name: :construction_bâtiment: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: :colis: Install dependencies
        run: npm ci
      - name: :pomme: Build iOS for TestFlight
        id: ios_build
        run: |
          echo ":marteau: Building iOS app for TestFlight submission..."
          echo ":réveil: Started at: $(date)"
          eas build --platform ios --profile preview --non-interactive --wait
          echo ":coche_blanche: Build completed at: $(date)"
      - name: :fusée: Submit to TestFlight
        id: ios_submit
        run: |
          echo ":fusée: Submitting to TestFlight..."
          eas submit --platform ios --profile preview --latest --non-interactive
          echo ":coche_blanche: Submitted at: $(date)"
      - name: :tada: Success Summary
        if: success()
        run: |
          echo "## :tada: iOS Build & TestFlight Success! :fusée:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### :coche_blanche: What Just Happened:" >> $GITHUB_STEP_SUMMARY
          echo "- :marteau: **iOS app built successfully** using EAS Build" >> $GITHUB_STEP_SUMMARY
          echo "- :fusée: **Automatically uploaded to TestFlight**" >> $GITHUB_STEP_SUMMARY
          echo "- :iphone: **Testers will receive notifications** shortly" >> $GITHUB_STEP_SUMMARY
          echo "- :haute_tension: **No manual intervention needed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### :iphone: For Your Testers:" >> $GITHUB_STEP_SUMMARY
          echo "- Check the **TestFlight app** for the new build" >> $GITHUB_STEP_SUMMARY
          echo "- New build will be available for **internal testing immediately**" >> $GITHUB_STEP_SUMMARY
          echo "- Push notifications should arrive **within 5-10 minutes**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### :histogramme: Build Info:" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build completed:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":fléchette: **Next deployment:** Push to \`dev\` branch again anytime!" >> $GITHUB_STEP_SUMMARY
      - name: :x: Failure Summary
        if: failure()
        run: |
          echo "## :x: iOS Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### :loupe_gauche: Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Check the build logs** above for specific error messages" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verify credentials** - run \`eas build --platform ios --profile preview --auto-submit\` locally" >> $GITHUB_STEP_SUMMARY
          echo "3. **Check App Store Connect** - ensure your app and certificates are active" >> $GITHUB_STEP_SUMMARY
          echo "4. **Verify bundle identifier** matches what's configured in App Store Connect" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### :clé_anglaise: Quick Fixes:" >> $GITHUB_STEP_SUMMARY
          echo "- If credentials issue: Run \`eas credentials -p ios\` locally" >> $GITHUB_STEP_SUMMARY
          echo "- If build issue: Check \`app.json\` and \`eas.json\` configuration" >> $GITHUB_STEP_SUMMARY
          echo "- If submission issue: Check App Store Connect API key status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed at:** $(date)" >> $GITHUB_STEP_SUMMARY
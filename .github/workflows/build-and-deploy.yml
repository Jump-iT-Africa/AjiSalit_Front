name: ðŸŽ iOS Build & TestFlight Deploy

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}

jobs:
  ios-build-and-deploy:
    name: ðŸš€ Build iOS & Deploy to TestFlight
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: ðŸ— Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ Build iOS for TestFlight
        id: ios_build
        run: |
          echo "ðŸ”¨ Building iOS app for TestFlight submission..."
          echo "â° Started at: $(date)"
          eas build --platform ios --profile preview --non-interactive --wait
          echo "âœ… Build completed at: $(date)"

      - name: ðŸš€ Submit to TestFlight
        id: ios_submit
        run: |
          echo "ðŸš€ Submitting to TestFlight..."
          eas submit --platform ios --profile preview --latest --non-interactive
          echo "âœ… Submitted at: $(date)"

      - name: ðŸŽ‰ Success Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ iOS Build & TestFlight Success! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… What Just Happened:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¨ **iOS app built successfully** using EAS Build" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **Automatically uploaded to TestFlight**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± **Testers will receive notifications** shortly" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ **No manual intervention needed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± For Your Testers:" >> $GITHUB_STEP_SUMMARY
          echo "- Check the **TestFlight app** for the new build" >> $GITHUB_STEP_SUMMARY
          echo "- New build will be available for **internal testing immediately**" >> $GITHUB_STEP_SUMMARY
          echo "- Push notifications should arrive **within 5-10 minutes**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Info:" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build completed:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Next deployment:** Push to \`dev\` branch again anytime!" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Failure Summary
        if: failure()
        run: |
          echo "## âŒ iOS Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Check the build logs** above for specific error messages" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verify credentials** - run \`eas build --platform ios --profile preview --auto-submit\` locally" >> $GITHUB_STEP_SUMMARY
          echo "3. **Check App Store Connect** - ensure your app and certificates are active" >> $GITHUB_STEP_SUMMARY
          echo "4. **Verify bundle identifier** matches what's configured in App Store Connect" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Quick Fixes:" >> $GITHUB_STEP_SUMMARY
          echo "- If credentials issue: Run \`eas credentials -p ios\` locally" >> $GITHUB_STEP_SUMMARY
          echo "- If build issue: Check \`app.json\` and \`eas.json\` configuration" >> $GITHUB_STEP_SUMMARY
          echo "- If submission issue: Check App Store Connect API key status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed at:** $(date)" >> $GITHUB_STEP_SUMMARY

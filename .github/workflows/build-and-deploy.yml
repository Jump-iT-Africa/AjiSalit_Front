name: iOS Build and TestFlight Deploy

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}

jobs:
  build-ios:
    name: Build iOS & Submit to TestFlight
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🍎 Build iOS & Submit to TestFlight
        run: |
          echo "🔨 Building iOS app and submitting to TestFlight..."
          eas build --platform ios --profile preview --auto-submit --non-interactive --wait

      - name: 🎉 Success Summary
        if: success()
        run: |
          echo "## 🎉 iOS Build & TestFlight Upload Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ What happened:" >> $GITHUB_STEP_SUMMARY
          echo "- 🔨 iOS app built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- 🚀 Automatically submitted to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- 📱 Testers will receive notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📱 Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Check TestFlight app for the new build" >> $GITHUB_STEP_SUMMARY
          echo "- Your testers should receive notifications automatically" >> $GITHUB_STEP_SUMMARY
          echo "- Build will be available for internal testing immediately" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build completed at:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: ❌ Failure Summary
        if: failure()
        run: |
          echo "## ❌ iOS Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔍 Troubleshooting:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the build logs above for specific errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify App Store Connect API credentials in EAS" >> $GITHUB_STEP_SUMMARY
          echo "3. Ensure your Apple Developer account is active" >> $GITHUB_STEP_SUMMARY
          echo "4. Check that bundle identifier matches App Store Connect" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed at:** $(date)" >> $GITHUB_STEP_SUMMARY

  # PR Validation (no builds, just validation)
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: 📦 Install dependencies
        run: npm ci

      - name: ✅ PR Validation Complete
        run: |
          echo "✅ Pull Request validation complete!" >> $GITHUB_STEP_SUMMARY
          echo "📋 iOS build will run when merged to dev branch" >> $GITHUB_STEP_SUMMARY
          echo "🎯 Merge this PR to trigger TestFlight upload" >> $GITHUB_STEP_SUMMARY